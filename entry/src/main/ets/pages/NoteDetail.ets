import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { storage } from '../utils/Storage';
import promptAction from '@ohos.promptAction';
import http from '@ohos.net.http';
import { ThemePreset } from '../utils/Types';
import { DEFAULT_THEME_ID, ThemeColorKey, cloneThemePreset, cloneThemePresets, getThemeById, getThemeColorValue } from '../utils/Theme';

// å®šä¹‰è·¯ç”±å‚æ•°æ¥å£
interface NoteParams {
  noteContent?: string;
  noteIndex?: number;
}

interface Message {
  role: string;
  content: string;
}

interface GeneratedTypeLiteralInterface_3 {
  message: GeneratedTypeLiteralInterface_4;
}

interface GeneratedTypeLiteralInterface_4 {
  content: string;
}

@Entry
@Component
struct NoteDetail {
  @State noteContent: string = '';
  @State editedContent: string = '';
  @State noteIndex: number = -1;
  @State showToolbar: boolean = true; // å·¥å…·æ æ˜¾ç¤ºçŠ¶æ€
  @State toolbarOpacity: number = 1; // å·¥å…·æ é€æ˜åº¦
  @State toolbarOffset: number = 0; // å·¥å…·æ å‚ç›´ä½ç§»
  @State isAnalyzing: boolean = false; // AIåˆ†æçŠ¶æ€
  @State showLoading: boolean = false; // åŠ è½½åŠ¨ç”»æ˜¾ç¤º
  @State themePresets: ThemePreset[] = cloneThemePresets();
  @State selectedThemeId: string = DEFAULT_THEME_ID;

  getCurrentTheme(): ThemePreset {
    return getThemeById(this.selectedThemeId, this.themePresets);
  }

  getThemeColor(key: ThemeColorKey): string {
    return getThemeColorValue(this.getCurrentTheme(), key);
  }

  async syncThemePresetsFromStorage() {
    const presets = cloneThemePresets();
    const customTheme = await storage.getCustomThemePreset();
    if (customTheme) {
      presets.push(cloneThemePreset(customTheme));
    }
    this.themePresets = presets;
  }

  async refreshTheme() {
    await this.syncThemePresetsFromStorage();
    const themeId = await storage.getThemePreference();
    if (themeId && this.themePresets.some((theme: ThemePreset) => theme.id === themeId)) {
      this.selectedThemeId = themeId;
    } else {
      this.selectedThemeId = DEFAULT_THEME_ID;
    }
  }

  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await storage.init(context);
    await this.refreshTheme();

    const params = router.getParams() as NoteParams;
    this.noteContent = params.noteContent || '';
    this.noteIndex = params.noteIndex || -1;
    this.editedContent = this.noteContent;
    
    // å¦‚æœæ˜¯ä»å­˜å‚¨ä¸­æ¢å¤çš„ç¬”è®°ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
    if (this.noteIndex >= 0) {
      const historyNotes = await storage.getHistoryNotes();
      if (historyNotes[this.noteIndex] && historyNotes[this.noteIndex] !== this.editedContent) {
        this.editedContent = historyNotes[this.noteIndex];
        this.noteContent = historyNotes[this.noteIndex];
      }
    }
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°ï¼ˆAIåˆ†æå¯èƒ½å·²å®Œæˆï¼‰
  async onPageShow() {
    await this.refreshTheme();
    if (this.noteIndex >= 0) {
      const historyNotes = await storage.getHistoryNotes();
      if (historyNotes[this.noteIndex] && historyNotes[this.noteIndex] !== this.editedContent) {
        this.editedContent = historyNotes[this.noteIndex];
        this.noteContent = historyNotes[this.noteIndex];
      }
    }
  }

  async saveNote() {
    if (this.editedContent.trim() === '') {
      promptAction.showToast({
        message: 'å†…å®¹ä¸èƒ½ä¸ºç©º',
        duration: 2000
      });
      return;
    }

    if (this.noteIndex >= 0) {
      // ç¼–è¾‘å·²æœ‰ç¬”è®°
      const historyNotes = await storage.getHistoryNotes();
      historyNotes[this.noteIndex] = this.editedContent;
      await storage.saveHistoryNotes(historyNotes);
    } else {
      // åˆ›å»ºæ–°ç¬”è®°
      const historyNotes = await storage.getHistoryNotes();
      historyNotes.unshift(this.editedContent); // æ·»åŠ åˆ°å†å²ç¬”è®°åˆ—è¡¨çš„å¼€å¤´
      await storage.saveHistoryNotes(historyNotes);
      // æ›´æ–°ç´¢å¼•ä¸º0ï¼Œå› ä¸ºæ–°ç¬”è®°è¢«æ·»åŠ åˆ°äº†åˆ—è¡¨å¼€å¤´
      this.noteIndex = 0;
    }
    
    // è¿”å›é¦–é¡µå¹¶ä¼ é€’æ›´æ–°åçš„å†…å®¹å’Œç´¢å¼•
    router.back({
      url: 'pages/Index',
      params: {
        content: this.editedContent,
        index: this.noteIndex
      }
    });
  }

  // è·å–å­—æ•°ç»Ÿè®¡
  getWordCount(): number {
    return this.editedContent.replace(/\s/g, '').length;
  }

  // æ’å…¥æ–‡æœ¬åˆ°å…‰æ ‡ä½ç½®
  insertText(text: string) {
    // æ³¨æ„ï¼šTextAreaç»„ä»¶åœ¨HarmonyOSä¸­å¯èƒ½ä¸æ”¯æŒç›´æ¥æ’å…¥æ–‡æœ¬åˆ°å…‰æ ‡ä½ç½®
    // è¿™é‡Œé‡‡ç”¨è¿½åŠ åˆ°æœ«å°¾çš„æ–¹å¼
    this.editedContent += text;
  }

  // æ’å…¥å½“å‰æ—¥æœŸ
  insertDate() {
    const date = new Date();
    const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    this.insertText(dateStr);
  }

  // æ’å…¥å½“å‰æ—¶é—´
  insertTime() {
    const date = new Date();
    const timeStr = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    this.insertText(timeStr);
  }

  // æ’å…¥åˆ†éš”çº¿
  insertDivider() {
    this.insertText('\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n');
  }

  // æ’å…¥å¾…åŠäº‹é¡¹æ ¼å¼
  insertTodo() {
    this.insertText('\nâ–¡ ');
  }

  // æ’å…¥æ ‡é¢˜æ ¼å¼
  insertTitle() {
    this.insertText('\nã€æ ‡é¢˜ã€‘\n');
  }

  toggleToolbar() {
    if (!this.showToolbar) {
      this.showToolbar = true;
      this.toolbarOpacity = 0;
      this.toolbarOffset = -8;
      animateTo({
        duration: 280,
        curve: 'easeInOut'
      }, () => {
        this.toolbarOpacity = 1;
        this.toolbarOffset = 0;
      });
    } else {
      animateTo({
        duration: 240,
        curve: 'easeInOut'
      }, () => {
        this.toolbarOpacity = 0;
        this.toolbarOffset = -8;
      });
      setTimeout(() => {
        this.showToolbar = false;
      }, 210);
    }
  }

  // å…¨é€‰æ–‡æœ¬
  selectAll() {
    // TextAreaç»„ä»¶å¯èƒ½éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼å®ç°å…¨é€‰
    promptAction.showToast({
      message: 'è¯·é•¿æŒ‰æ–‡æœ¬åŒºåŸŸè¿›è¡Œå…¨é€‰',
      duration: 2000
    });
  }

  // æ¸…ç©ºå†…å®¹
  clearContent() {
    promptAction.showDialog({
      title: 'ç¡®è®¤æ¸…ç©º',
      message: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#666666' },
        { text: 'æ¸…ç©º', color: '#FF3B30' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        this.editedContent = '';
        promptAction.showToast({
          message: 'å†…å®¹å·²æ¸…ç©º',
          duration: 2000
        });
      }
    }).catch((err: Error) => {
      console.error(`æ¸…ç©ºç¡®è®¤å¯¹è¯æ¡†é”™è¯¯: ${err}`);
    });
  }

  // AIåˆ†æç¬”è®°
  async analyzeNoteWithAI() {
    if (this.editedContent.trim().length === 0) {
      promptAction.showToast({
        message: 'ç¬”è®°å†…å®¹ä¸èƒ½ä¸ºç©º',
        duration: 2000
      });
      return;
    }

    // ä¿å­˜å½“å‰å†…å®¹åˆ°å†å²ç¬”è®°ï¼Œä»¥ä¾¿é€€å‡ºé¡µé¢åä¹Ÿèƒ½æ›´æ–°
    if (this.noteIndex >= 0) {
      const historyNotes = await storage.getHistoryNotes();
      historyNotes[this.noteIndex] = this.editedContent;
      await storage.saveHistoryNotes(historyNotes);
    }

    this.isAnalyzing = true;
    this.showLoading = true;

    const client = http.createHttp();
    try {
      const resp = await client.request(
        'https://api.deepseek.com/v1/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-20faf5c818224258a495651e2d663907'
          },
          extraData: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content:
                  'ä½ æ˜¯ã€Œä¸“ä¸šç¬”è®°æ•´ç†åŠ©æ‰‹ + æ³¨å†Œè¥å…»å¸ˆã€ã€‚\n' +
                  '1. å…ˆè¯†åˆ«ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ç±»å‹ï¼ˆä¼šè®®/å¾…åŠ/å­¦ä¹ /ä¹°èœ/å…¶ä»–ï¼‰ã€‚\n' +
                  '2. æŒ‰å¯¹åº”æ¨¡æ¿è¾“å‡ºçº¯æ–‡æœ¬ç¬”è®°ï¼Œå±‚çº§ç”¨ã€ã€‘æˆ–â‘ â‘¡â‘¢ï¼Œç¦ç”¨Markdownã€‚\n' +
                  '3. è‹¥ä¿¡æ¯ç¼ºå¤±ï¼Œç›´æ¥è¡¥å»ºè®®å¹¶æ ‡æ³¨ã€å¾…ç¡®è®¤ã€‘ã€‚\n' +
                  '4. å½“æ£€æµ‹åˆ°ä¹°èœã€é£Ÿæã€é¥®é£Ÿã€å¥åº·ç›¸å…³å…³é”®è¯ï¼Œç«‹å³åˆ‡æ¢è¥å…»å¸ˆèº«ä»½ï¼š\n' +
                  '   - ç”Ÿæˆå½“å¤©3é¤é£Ÿææ¸…å•ï¼ˆè”¬èœ/è›‹ç™½/ä¸»é£Ÿ/æ°´æœ/è°ƒå‘³ï¼‰ã€‚\n' +
                  '   - æ ‡æ³¨æ¯äººä»½é‡â‰ˆçƒ­é‡ã€è›‹ç™½è´¨ã€å…³é”®è¥å…»ç´ ã€‚\n' +
                  '   - ç»™å‡ºå‚¨å­˜å°è´´å£«ï¼ˆå†·è—/å†·å†»/å¸¸æ¸©å¤©æ•°ï¼‰ã€‚\n' +
                  '5. è¾“å‡ºç¤ºä¾‹ï¼š\n' +
                  'ã€ä»Šæ—¥3äººé¤é£Ÿææ¸…å•ã€‘\n' +
                  'â‘  è”¬èœï¼šè¥¿å…°èŠ±300gï¼ˆç»´Câ‰ˆ135mgï¼‰\n' +
                  'â‘¡ è›‹ç™½ï¼šå»çš®é¸¡èƒ¸400gï¼ˆè›‹ç™½â‰ˆ92gï¼Œä½è„‚ï¼‰\n' +
                  'â‘¢ ä¸»é£Ÿï¼šç³™ç±³200gï¼ˆä½GIï¼‰\n' +
                  'â‘£ æ°´æœï¼šè“è“150gï¼ˆèŠ±é’ç´ æŠ¤çœ¼ï¼‰\n' +
                  'â‘¤ è°ƒå‘³ï¼šåˆæ¦¨æ©„æ¦„æ²¹20ml\n' +
                  'å‚¨å­˜ï¼šé¸¡èƒ¸åˆ†2è¢‹å†·å†»ï¼Œè”¬èœ3å¤©å†…å†·è—ç”¨å®Œã€‚\n' +
                  'ã€å¾…ç¡®è®¤ã€‘è¯·è¡¥å……ç”¨é¤äººæ•°/å¿Œå£/é¢„ç®—/çƒ¹é¥ªæ–¹å¼ã€‚'
              } as Message,
              {
                role: 'user',
                content: `è¯·æ•´ç†ä»¥ä¸‹ç¬”è®°å†…å®¹ï¼š${this.editedContent}`
              } as Message
            ] as Message[],
            max_tokens: 500
          })
        }
      );

      if (resp.responseCode === 200) {
        interface DeepSeekResponse {
          choices: Array<GeneratedTypeLiteralInterface_3>;
        }

        const body: DeepSeekResponse = JSON.parse(resp.result.toString());
        const analyzedContent = body.choices[0].message.content.trim();
        this.editedContent = analyzedContent;
        
        // æ— è®ºæ˜¯å¦è¿˜åœ¨é¡µé¢ï¼Œéƒ½ä¿å­˜åˆ†æç»“æœåˆ°å†å²ç¬”è®°
        if (this.noteIndex >= 0) {
          const historyNotes = await storage.getHistoryNotes();
          historyNotes[this.noteIndex] = analyzedContent;
          await storage.saveHistoryNotes(historyNotes);
        }
        
        promptAction.showToast({
          message: 'AIåˆ†æå®Œæˆ',
          duration: 2000
        });
      } else {
        promptAction.showToast({
          message: `åˆ†æå¤±è´¥ï¼šHTTPé”™è¯¯ç  ${resp.responseCode}`,
          duration: 3000
        });
      }
    } catch (err) {
      promptAction.showToast({
        message: `åˆ†æå¤±è´¥ï¼š${JSON.stringify(err)}`,
        duration: 3000
      });
    } finally {
      this.isAnalyzing = false;
      this.showLoading = false;
      client.destroy();
    }
  }

  // æ¸²æŸ“å·¥å…·æ 
  @Builder
  renderToolbar() {
    Column() {
      // å·¥å…·æ æ ‡é¢˜æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
      Row() {
        Text('ğŸ“ ç¼–è¾‘å·¥å…·')
          .fontSize(14)
          .fontColor(this.getThemeColor('textColor'))
        Blank()
        Text(this.showToolbar ? 'æ”¶èµ· â–²' : 'å±•å¼€ â–¼')
          .fontSize(12)
          .fontColor(this.getThemeColor('accentColor'))
          .onClick(() => {
            this.toggleToolbar();
          })
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })

      // å·¥å…·æ æŒ‰é’®ï¼ˆå¯æ”¶èµ·ï¼‰
      if (this.showToolbar || this.toolbarOpacity > 0) {
        Scroll() {
          Row({ space: 12 }) {
            // æ—¥æœŸ
            this.renderToolbarButton('ğŸ“… æ—¥æœŸ', () => {
              this.insertDate();
            })
            
            // æ—¶é—´
            this.renderToolbarButton('ğŸ• æ—¶é—´', () => {
              this.insertTime();
            })
            
            // åˆ†éš”çº¿
            this.renderToolbarButton('â– åˆ†éš”çº¿', () => {
              this.insertDivider();
            })
            
            // å¾…åŠ
            this.renderToolbarButton('â˜ å¾…åŠ', () => {
              this.insertTodo();
            })
            
            // æ ‡é¢˜
            this.renderToolbarButton('ğŸ“Œ æ ‡é¢˜', () => {
              this.insertTitle();
            })
            
            // å…¨é€‰
            this.renderToolbarButton('âœ“ å…¨é€‰', () => {
              this.selectAll();
            })
            
            // æ¸…ç©º
            this.renderToolbarButton('ğŸ—‘ï¸ æ¸…ç©º', () => {
              this.clearContent();
            })
          }
          .padding({ left: 20, right: 20, bottom: 8 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .edgeEffect(EdgeEffect.Spring)
        .height(50)
        .opacity(this.toolbarOpacity)
        .translate({ y: this.toolbarOffset })
      }

      // å­—æ•°ç»Ÿè®¡ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
      Row() {
        Text(`å­—æ•°ï¼š${this.getWordCount()}`)
          .fontSize(12)
          .fontColor(this.getThemeColor('mutedTextColor'))
        Blank()
        Text(`è¡Œæ•°ï¼š${this.editedContent.split('\n').length}`)
          .fontSize(12)
          .fontColor(this.getThemeColor('mutedTextColor'))
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 4, bottom: 8 })
    }
    .width('100%')
    .backgroundColor(this.getThemeColor('cardColor'))
    .border({ width: { bottom: 0.5 }, color: '#E5E5EA' })
  }

  // æ¸²æŸ“å·¥å…·æ æŒ‰é’®
  @Builder
  renderToolbarButton(label: string, onClick: () => void) {
    Button(label)
      .fontSize(13)
      .fontColor(this.getThemeColor('textColor'))
      .backgroundColor(this.getThemeColor('cardColor'))
      .borderRadius(16)
      .height(36)
      .padding({ left: 12, right: 12 })
      .onClick(onClick)
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.ic_backup'))
          .width(28)
          .height(28)
          .padding(4)
          .margin({ right: 12 })
          .onClick(() => {
            router.back();
          })
        Text('ç¬”è®°è¯¦æƒ…')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getThemeColor('textColor'))
        Blank()
        Button('ä¿å­˜')
          .fontSize(15)
          .fontColor('#FFFFFF')
          .backgroundColor(this.getThemeColor('accentColor'))
          .borderRadius(20)
          .height(36)
          .padding({ left: 20, right: 20 })
          .onClick(() => {
            this.saveNote();
          })
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })
      .backgroundColor(this.getThemeColor('cardColor'))

      Divider().strokeWidth(0.5).color('#E5E5EA')

      // å·¥å…·æ ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œä½†å†…å®¹å¯æ”¶èµ·ï¼‰
      this.renderToolbar()

      // ç¬”è®°å†…å®¹ç¼–è¾‘åŒº
      Column() {
        TextArea({ placeholder: 'è¯·è¾“å…¥ç¬”è®°å†…å®¹...', text: this.editedContent })
          .width('100%')
          .height('100%')
          .fontSize(16)
          .fontColor(this.getThemeColor('textColor'))
          .lineHeight(24)
          .backgroundColor(this.getThemeColor('cardColor'))
          .placeholderColor(this.getThemeColor('mutedTextColor'))
          .padding(20)
          .onChange((value: string) => {
            this.editedContent = value;
          })
      }
      .layoutWeight(1)
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })

      // æ“ä½œåŒºåŸŸ
      Column({ space: 12 }) {
        Row({ space: 12 }) {
          Button('AIåˆ†æ')
            .layoutWeight(1)
            .height(44)
            .fontSize(16)
            .fontColor('#FFFFFF')
            .backgroundColor(this.getThemeColor('accentColor'))
            .borderRadius(22)
            .onClick(() => {
              this.analyzeNoteWithAI();
            })
            .enabled(!this.isAnalyzing)
        }
        .width('100%')
        .padding({ left: 20, right: 20 })

        if (this.showLoading) {
          Row() {
            LoadingProgress()
              .color(this.getThemeColor('accentColor'))
              .width(20)
              .height(20)
            Text('AIæ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...')
              .fontSize(14)
              .fontColor(this.getThemeColor('mutedTextColor'))
              .margin({ left: 8 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .padding({ bottom: 8 })
        }
      }

    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.getThemeColor('backgroundColor'))
  }
}