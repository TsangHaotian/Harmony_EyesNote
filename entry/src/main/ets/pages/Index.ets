// Index.ets - ä¸»é¡µé¢ï¼ŒåŒ…å«åº•éƒ¨å¯¼èˆªæ 
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { storage } from '../utils/Storage';
import http from '@ohos.net.http';
import { HealthData } from '../utils/Types'; // å¯¼å…¥å…±äº«æ¥å£

interface RouterParams {
  content?: string;
  index?: number;
  healthData?: HealthData; // ä½¿ç”¨å…±äº«æ¥å£
}

interface Message {
  role: string;
  content: string;
}

// åˆ é™¤é‡å¤çš„ HealthData æ¥å£å®šä¹‰

interface GeneratedTypeLiteralInterface_2 {
  content: string;
}

interface GeneratedTypeLiteralInterface_1 {
  message: GeneratedTypeLiteralInterface_2;
}

interface GeneratedTypeLiteralInterface_4 {
  content: string;
}

interface GeneratedTypeLiteralInterface_3 {
  message: GeneratedTypeLiteralInterface_4;
}

interface GeneratedTypeLiteralInterface_6 {
  content: string;
}

interface GeneratedTypeLiteralInterface_5 {
  message: GeneratedTypeLiteralInterface_6;
}

@Entry
@Component
struct Index {
  // åº•éƒ¨å¯¼èˆªæ ç›¸å…³çŠ¶æ€
  @State selectedIndex: number = 0; // 0: ç¬”è®°é¡µé¢, 1: å¥åº·é¡µé¢, 2: AIé¡µé¢
  // ç¬”è®°é¡µé¢ç›¸å…³çŠ¶æ€
  analyzedNote: string = "";
  isAnalyzing: boolean = false;
  @State showLoading: boolean = false; // æ§åˆ¶åŠ è½½åŠ¨ç”»æ˜¾ç¤º
  @State currentNote: string = '';
  @State historyNotes: string[] = [];
  @State defaultTemplates: string[] = [
    'ä¼šè®®è®°å½•æ¨¡æ¿ï¼š\n\nä¼šè®®ä¸»é¢˜ï¼š\næ—¶é—´ï¼š\nåœ°ç‚¹ï¼š\nå‚ä¸äººå‘˜ï¼š\n\nè®®ç¨‹ï¼š\n1. \n2. \n3. \n\nå¾…åŠäº‹é¡¹ï¼š',
    'è´­ç‰©æ¸…å•ï¼š\n\nğŸ¥¬ è”¬èœç±»ï¼š\nğŸ¥© è‚‰ç±»ï¼š\nğŸ¥› å¥¶åˆ¶å“ï¼š\nğŸ ä¸»é£Ÿï¼š\nğŸ§¹ æ—¥ç”¨å“ï¼š',
    'å­¦ä¹ è®¡åˆ’ï¼š\n\nğŸ“š ä»Šæ—¥å­¦ä¹ ç›®æ ‡ï¼š\nâ° é¢„è®¡ç”¨æ—¶ï¼š\nğŸ“– é‡ç‚¹å†…å®¹ï¼š\nâœ… å®Œæˆæƒ…å†µï¼š'
  ];
  @State customTemplates: string[] = [];
  @State allTemplates: string[] = [];
  // å¥åº·é¡µé¢ç›¸å…³çŠ¶æ€
  @State waterCount: number = 0;
  @State sleepHours: number = 7;
  @State stepsCount: number = 0;
  @State mood: string = 'å¼€å¿ƒ';
  // AIé¡µé¢ç›¸å…³çŠ¶æ€
  @State aiMessages: Message[] = [];
  @State aiInput: string = '';
  @State isAIChatting: boolean = false;

  // é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await storage.init(context);

    // åŠ è½½ç¬”è®°æ•°æ®
    const savedNotes = await storage.getHistoryNotes();
    if (savedNotes.length > 0) {
      this.historyNotes = savedNotes;
    } else {
      this.historyNotes = ['æ¬¢è¿ä½¿ç”¨çœ¨çœ¼ç¬”è®°ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿè®°å½•å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è®°å½•æ‚¨çš„æƒ³æ³•'];
    }

    const savedCurrentNote = await storage.getCurrentNote();
    if (savedCurrentNote) {
      this.currentNote = savedCurrentNote;
    }

    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];

    // æ–°å¢ï¼šåŠ è½½å¥åº·æ•°æ®
    try {
      const savedHealthData = await storage.getHealthData();
      this.waterCount = savedHealthData.waterCount || 0;
      this.sleepHours = savedHealthData.sleepHours || 7;
      this.stepsCount = savedHealthData.stepsCount || 0;
      this.mood = savedHealthData.mood || 'å¼€å¿ƒ';
    } catch (error) {
      console.error(`åŠ è½½å¥åº·æ•°æ®å¤±è´¥: ${error}`);
    }
  }

  // é¡µé¢è¿”å›æ—¶å¤„ç†æ•°æ®
  async onPageShow() {
    const result = router.getParams() as RouterParams;
    if (result && result.content !== undefined && result.index !== undefined) {
      const newContent = result.content;
      const index = result.index;
      if (index >= 0 && index < this.historyNotes.length) {
        this.historyNotes[index] = newContent;
        await storage.saveHistoryNotes(this.historyNotes);
      }
    }

    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];

    // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
    await this.saveHealthData();
  }

  // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
  async saveHealthData() {
    const healthData: HealthData = {
      waterCount: this.waterCount,
      sleepHours: this.sleepHours,
      stepsCount: this.stepsCount,
      mood: this.mood
    };
    await storage.saveHealthData(healthData); // ç°åœ¨ç±»å‹åŒ¹é…
  }

  // ç¬”è®°é¡µé¢æ–¹æ³•
  openNoteDetail(note: string, index: number) {
    router.pushUrl({
      url: 'pages/NoteDetail',
      params: {
        noteContent: note,
        noteIndex: index
      }
    });
  }

  async saveNote() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.historyNotes.unshift(this.currentNote.trim());
    this.currentNote = '';

    await storage.saveHistoryNotes(this.historyNotes);
    await storage.saveCurrentNote('');
  }

  async deleteNote(index: number) {
    this.historyNotes.splice(index, 1);
    await storage.saveHistoryNotes(this.historyNotes);
  }

  async analyzeNoteWithAI() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.isAnalyzing = true;
    this.showLoading = true; // æ–°å¢ï¼šæ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    this.analyzedNote = 'æ­£åœ¨åˆ†æä¸­...';

    const client = http.createHttp();
    try {
      const resp = await client.request(
        'https://api.deepseek.com/v1/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-20faf5c818224258a495651e2d663907'
          },
          extraData: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content:
                'ä½ æ˜¯ã€Œä¸“ä¸šç¬”è®°æ•´ç†åŠ©æ‰‹ + æ³¨å†Œè¥å…»å¸ˆã€ã€‚\n' +
                  '1. å…ˆè¯†åˆ«ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ç±»å‹ï¼ˆä¼šè®®/å¾…åŠ/å­¦ä¹ /ä¹°èœ/å…¶ä»–ï¼‰ã€‚\n' +
                  '2. æŒ‰å¯¹åº”æ¨¡æ¿è¾“å‡ºçº¯æ–‡æœ¬ç¬”è®°ï¼Œå±‚çº§ç”¨ã€ã€‘æˆ–â‘ â‘¡â‘¢ï¼Œç¦ç”¨Markdownã€‚\n' +
                  '3. è‹¥ä¿¡æ¯ç¼ºå¤±ï¼Œç›´æ¥è¡¥å»ºè®®å¹¶æ ‡æ³¨ã€å¾…ç¡®è®¤ã€‘ã€‚\n' +
                  '4. å½“æ£€æµ‹åˆ°ä¹°èœã€é£Ÿæã€é¥®é£Ÿã€å¥åº·ç›¸å…³å…³é”®è¯ï¼Œç«‹å³åˆ‡æ¢è¥å…»å¸ˆèº«ä»½ï¼š\n' +
                  '   - ç”Ÿæˆå½“å¤©3é¤é£Ÿææ¸…å•ï¼ˆè”¬èœ/è›‹ç™½/ä¸»é£Ÿ/æ°´æœ/è°ƒå‘³ï¼‰ã€‚\n' +
                  '   - æ ‡æ³¨æ¯äººä»½é‡â‰ˆçƒ­é‡ã€è›‹ç™½è´¨ã€å…³é”®è¥å…»ç´ ã€‚\n' +
                  '   - ç»™å‡ºå‚¨å­˜å°è´´å£«ï¼ˆå†·è—/å†·å†»/å¸¸æ¸©å¤©æ•°ï¼‰ã€‚\n' +
                  '5. è¾“å‡ºç¤ºä¾‹ï¼š\n' +
                  'ã€ä»Šæ—¥3äººé¤é£Ÿææ¸…å•ã€‘\n' +
                  'â‘  è”¬èœï¼šè¥¿å…°èŠ±300gï¼ˆç»´Câ‰ˆ135mgï¼‰\n' +
                  'â‘¡ è›‹ç™½ï¼šå»çš®é¸¡èƒ¸400gï¼ˆè›‹ç™½â‰ˆ92gï¼Œä½è„‚ï¼‰\n' +
                  'â‘¢ ä¸»é£Ÿï¼šç³™ç±³200gï¼ˆä½GIï¼‰\n' +
                  'â‘£ æ°´æœï¼šè“è“150gï¼ˆèŠ±é’ç´ æŠ¤çœ¼ï¼‰\n' +
                  'â‘¤ è°ƒå‘³ï¼šåˆæ¦¨æ©„æ¦„æ²¹20ml\n' +
                  'å‚¨å­˜ï¼šé¸¡èƒ¸åˆ†2è¢‹å†·å†»ï¼Œè”¬èœ3å¤©å†…å†·è—ç”¨å®Œã€‚\n' +
                  'ã€å¾…ç¡®è®¤ã€‘è¯·è¡¥å……ç”¨é¤äººæ•°/å¿Œå£/é¢„ç®—/çƒ¹é¥ªæ–¹å¼ã€‚'
              } as Message,
              {
                role: 'user',
                content: `è¯·æ•´ç†ä»¥ä¸‹ç¬”è®°å†…å®¹ï¼š${this.currentNote}`
              } as Message
            ] as Message[],
            max_tokens: 500
          })
        }
      );

      if (resp.responseCode === 200) {
        interface DeepSeekResponse {
          choices: Array<GeneratedTypeLiteralInterface_3>;
        }

        const body: DeepSeekResponse = JSON.parse(resp.result.toString());
        this.analyzedNote = body.choices[0].message.content.trim();
        this.currentNote = this.analyzedNote;
      } else {
        this.analyzedNote = `åˆ†æå¤±è´¥ï¼šHTTPé”™è¯¯ç  ${resp.responseCode}`;
      }
    } catch (err) {
      this.analyzedNote = `åˆ†æå¤±è´¥ï¼š${JSON.stringify(err)}`;
    } finally {
      this.isAnalyzing = false;
      this.showLoading = false; // æ–°å¢ï¼šéšè—åŠ è½½åŠ¨ç”»
      client.destroy();
    }
  }

  // å¥åº·é¡µé¢æ–¹æ³•
  incrementWater() {
    this.waterCount += 1;
    this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
  }

  decrementWater() {
    if (this.waterCount > 0) {
      this.waterCount -= 1;
      this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
    }
  }

  incrementSteps() {
    this.stepsCount += 100;
    this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
  }

  decrementSteps() {
    if (this.stepsCount >= 100) {
      this.stepsCount -= 100;
      this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
    }
  }

  changeSleep(hours: number) {
    this.sleepHours = Math.max(1, Math.min(12, this.sleepHours + hours));
    this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
  }

  changeMood(newMood: string) {
    this.mood = newMood;
    this.saveHealthData(); // æ–°å¢ï¼šä¿å­˜å¥åº·æ•°æ®
  }

  // æ–°å¢ï¼šè·³è½¬åˆ°AIé¡µé¢å¹¶ä¼ é€’å¥åº·æ•°æ®
  goToAIPage() {
    const healthData: HealthData = {
      waterCount: this.waterCount,
      sleepHours: this.sleepHours,
      stepsCount: this.stepsCount,
      mood: this.mood
    };
    router.pushUrl({
      url: 'pages/AIPage',
      params: {
        healthData: healthData
      }
    });
  }

  // æ–°å¢ï¼šAIå¯¹è¯æ–¹æ³•
  async sendAIMessage() {
    if (this.aiInput.trim().length === 0) {
      return;
    }

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: Message = {
      role: 'user',
      content: this.aiInput
    };
    this.aiMessages.push(userMessage);
    this.aiInput = '';
    this.isAIChatting = true;

    // å‡†å¤‡å¥åº·æ•°æ®
    const healthDataStr = `å¥åº·æ•°æ®ï¼š
- é¥®æ°´é‡ï¼š${this.waterCount}æ¯
- ç¡çœ æ—¶é—´ï¼š${this.sleepHours}å°æ—¶
- æ­¥æ•°ï¼š${this.stepsCount}æ­¥
- å¿ƒæƒ…ï¼š${this.mood}`;

    const client = http.createHttp();
    try {
      const resp = await client.request(
        'https://api.deepseek.com/v1/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-20faf5c818224258a495651e2d663907'
          },
          extraData: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content:
                'ä½ æ˜¯ã€Œå¥åº·é¡¾é—®AIåŠ©æ‰‹ã€ï¼Œä½ çš„ä»»åŠ¡æ˜¯ï¼š\n'
                  + '1. åˆ†æç”¨æˆ·æä¾›çš„å¥åº·æ•°æ®ï¼ˆé¥®æ°´é‡ã€ç¡çœ æ—¶é—´ã€æ­¥æ•°ã€å¿ƒæƒ…ï¼‰\n'
                  + '2. æä¾›ä¸ªæ€§åŒ–çš„å¥åº·å»ºè®®å’Œç”Ÿæ´»æ–¹å¼æ”¹è¿›æ„è§\n'
                  + '3. å›ç­”ç”¨æˆ·å…³äºå¥åº·ã€è¥å…»ã€è¿åŠ¨ç­‰æ–¹é¢çš„é—®é¢˜\n'
                  + '4. ä¿æŒå‹å¥½ã€ä¸“ä¸šçš„è¯­æ°”ï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€è§£é‡Šå¥åº·çŸ¥è¯†\n'
                  + '5. ç»“åˆç”¨æˆ·çš„å¥åº·æ•°æ®ç»™å‡ºå…·ä½“çš„ã€å¯æ“ä½œçš„å»ºè®®'
              } as Message,
              ...this.aiMessages,
              {
                role: 'system',
                content: healthDataStr
              } as Message
            ] as Message[],
            max_tokens: 1000
          })
        }
      );

      if (resp.responseCode === 200) {
        interface DeepSeekResponse {
          choices: Array<GeneratedTypeLiteralInterface_5>;
        }

        const response: DeepSeekResponse = JSON.parse(resp.result.toString());
        const aiResponse: Message = {
          role: 'assistant',
          content: response.choices[0].message.content.trim()
        };
        this.aiMessages.push(aiResponse);
      } else {
        const errorMessage: Message = {
          role: 'assistant',
          content: `è¯·æ±‚å¤±è´¥ï¼Œé”™è¯¯ç ï¼š${resp.responseCode}`
        };
        this.aiMessages.push(errorMessage);
      }
    } catch (error) {
      const errorMessage: Message = {
        role: 'assistant',
        content: `å‘ç”Ÿé”™è¯¯ï¼š${JSON.stringify(error)}`
      };
      this.aiMessages.push(errorMessage);
    } finally {
      this.isAIChatting = false;
      client.destroy();
    }
  }

  // ç¬”è®°é¡µé¢UI
  @Builder
  NotePage() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('çœ¨çœ¼ç¬”è®°')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
        Blank()
        Image($r("app.media.about"))
          .width(24)
          .height(24)
          .onClick(() => {
            router.pushUrl({ url: 'pages/Settings' });
          })
      }
      .width('100%')
      .height(66)
      .padding({
        left: 16,
        right: 16,
        top: 12,
        bottom: 12
      })
      .backgroundColor('#f5f5f5')

      Divider().strokeWidth(1).color('#1F000000')

      // æ¨¡æ¿å¡ç‰‡
      Column() {
        Text('ğŸ“‹ å¿«é€Ÿæ¨¡æ¿')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.allTemplates, (template: string, index: number) => {
              Column() {
                Text(template)
                  .fontSize(12)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .width('100%')
                  .padding(8)
                Button('ä½¿ç”¨')
                  .width('100%')
                  .height(28)
                  .fontSize(12)
                  .onClick(() => {
                    this.currentNote = template;
                  })
              }
              .width(120)
              .height(100)
              .padding(8)
              .backgroundColor('#FFF0F0F0')
              .borderRadius(8)
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 16, bottom: 8 })

      Divider().strokeWidth(1).color('#1F000000')

      // å½“å‰ç¬”è®°è¾“å…¥åŒº
      Column() {
        Text('å½“å‰ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'å†™ä¸‹ä½ çš„æƒ³æ³•â€¦', text: $$this.currentNote })
          .width('100%')
          .height(100)
          .backgroundColor('#FFECECEC')
          .borderRadius(8)

        Row({ space: 8 }) {
          Button('ä¿å­˜')
            .layoutWeight(1)
            .onClick(() => {
              this.saveNote();
            })

          Button('AIåˆ†æ')
            .layoutWeight(1)
            .backgroundColor('#FF4CAF50')
            .onClick(() => {
              this.analyzeNoteWithAI();
            })
            .enabled(!this.isAnalyzing)
        }
        .width('100%')
        .margin({ top: 8 })

        // æ–°å¢ï¼šAIåˆ†æåŠ è½½åŠ¨ç”»
        if (this.showLoading) {
          Row() {
            LoadingProgress()
              .color('#007AFF')
              .width(24)
              .height(24)
            Text('AIæ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...')
              .fontSize(14)
              .margin({ left: 8 })
          }
          .margin({ top: 12 })
          .justifyContent(FlexAlign.Center)
        }
      }
      .padding(16)

      Divider().strokeWidth(1).color('#1F000000')

      // å†å²ç¬”è®°åˆ—è¡¨
      Column() {
        Text('å†å²ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        List({ space: 8 }) {
          ForEach(this.historyNotes, (note: string, index: number) => {
            ListItem() {
              Row() {
                Text(note)
                  .fontSize(14)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
                Image($r('app.media.ic_delete'))
                  .width(18)
                  .height(18)
                  .onClick(() => {
                    this.deleteNote(index);
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#FFF5F5F5')
              .borderRadius(8)
              .onClick(() => {
                this.openNoteDetail(note, index);
              })
            }
          }, (note: string, index: number) => `${note}_${index}`)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        .scrollBar(BarState.Auto)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 8 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFFFF')
  }

  // å¥åº·é¡µé¢UI
  @Builder
  HealthPage() {
    Scroll() {
      Column({ space: 16 }) {
        // é¡¶éƒ¨æ ‡é¢˜
        Text('å¥åº·è¿½è¸ª')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 10 })

        // é¥®æ°´è¿½è¸ª
        Card() {
          Column({ space: 12 }) {
            Text('ğŸ’§ ä»Šæ—¥é¥®æ°´')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.waterCount} æ¯`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')

            Row({ space: 20 }) {
              Button('-')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick((): void => this.decrementWater())

              Button('+')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick((): void => this.incrementWater())
            }
          }
          .width('100%')
          .padding(20)
        }

        // ç¡çœ è®°å½•
        Card() {
          Column({ space: 12 }) {
            Text('ğŸ˜´ ç¡çœ æ—¶é—´')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.sleepHours} å°æ—¶`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')

            Row({ space: 20 }) {
              Button('-')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick((): void => this.changeSleep(-1))

              Button('+')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick((): void => this.changeSleep(1))
            }
          }
          .width('100%')
          .padding(20)
        }

        // æ­¥æ•°ç»Ÿè®¡
        Card() {
          Column({ space: 12 }) {
            Text('ğŸš¶ ä»Šæ—¥æ­¥æ•°')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.stepsCount} æ­¥`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')

            Row({ space: 20 }) {
              Button('-100')
                .width(60)
                .height(40)
                .borderRadius(20)
                .fontSize(12)
                .onClick((): void => this.decrementSteps())

              Button('+100')
                .width(60)
                .height(40)
                .borderRadius(20)
                .fontSize(12)
                .onClick((): void => this.incrementSteps())
            }
          }
          .width('100%')
          .padding(20)
        }

        // å¿ƒæƒ…è®°å½•
        Card() {
          Column({ space: 12 }) {
            Text('ğŸ˜Š ä»Šæ—¥å¿ƒæƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(this.mood)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#AF52DE')

            Row({ space: 10 }) {
              ForEach(['å¼€å¿ƒ', 'å¹³é™', 'ç–²æƒ«', 'ç„¦è™‘', 'å…´å¥‹'], (moodOption: string) => {
                Button(moodOption)
                  .height(35)
                  .borderRadius(18)
                  .fontSize(12)
                  .backgroundColor(this.mood === moodOption ? '#AF52DE' : '#E5E5EA')
                  .onClick((): void => this.changeMood(moodOption))
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceEvenly)
          }
          .width('100%')
          .padding(20)
        }
      }
      .padding(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF5F5F5')
  }

  // aié¡µé¢UI
  @Builder
  AIPage() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜
      Row() {
        Text('å¥åº·AIåŠ©æ‰‹')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
        Blank()
        Image($r("app.media.about"))
          .width(24)
          .height(24)
      }
      .width('100%')
      .height(66)
      .padding(16)
      .backgroundColor('#f5f5f5')

      Divider().strokeWidth(1).color('#1F000000')

      // èŠå¤©è®°å½•
      Scroll() {
        Column() {
          ForEach(this.aiMessages, (message: Message, index: number) => {
            if (message.role === 'user') {
              Row() {
                Blank()
                Text(message.content)
                  .backgroundColor('#007AFF')
                  .padding(12)
                  .borderRadius(16)
              }
              .width('100%')
              .padding(8)
            } else {
              Row() {
                Image($r('app.media.ic_ai'))
                  .width(40)
                  .height(40)
                  .borderRadius(20)
                Text(message.content)
                  .backgroundColor('#F5F5F5')
                  .padding(12)
                  .borderRadius(16)
                Blank()
              }
              .width('100%')
              .padding(8)
            }
          })
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)

      // è¾“å…¥åŒºåŸŸ
      Row() {
        TextInput({
          placeholder: 'è¾“å…¥ä½ çš„é—®é¢˜...',
          text: $$this.aiInput
        })
          .layoutWeight(1)
          .height(48)
          .backgroundColor('#F5F5F5')
          .borderRadius(24)
          .padding({ left: 16, right: 16 })

        Button('å‘é€')
          .width(80)
          .height(48)
          .backgroundColor('#007AFF')
          .borderRadius(24)
          .onClick(() => {
            this.sendAIMessage();
          })
          .enabled(!this.isAIChatting)
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ
      Stack() {
        if (this.selectedIndex === 0) {
          this.NotePage()
        } else if (this.selectedIndex === 1) {
          this.HealthPage()
        } else {
          this.AIPage()
        }
      }
      .layoutWeight(1)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // ç¬”è®°é¡µé¢æŒ‰é’®
        Column() {
          Image($r('app.media.ic_edit'))
            .width(24)
            .height(24)
            .fillColor(this.selectedIndex === 0 ? '#007AFF' : '#8E8E93')
          Text('ç¬”è®°')
            .fontSize(12)
            .fontColor(this.selectedIndex === 0 ? '#007AFF' : '#8E8E93')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .onClick(() => {
          this.selectedIndex = 0;
        })
        .alignItems(HorizontalAlign.Center)

        // å¥åº·é¡µé¢æŒ‰é’®
        Column() {
          Image($r('app.media.ic_right'))
            .width(24)
            .height(24)
            .fillColor(this.selectedIndex === 1 ? '#007AFF' : '#8E8E93')
          Text('å¥åº·')
            .fontSize(12)
            .fontColor(this.selectedIndex === 1 ? '#007AFF' : '#8E8E93')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .onClick(() => {
          this.selectedIndex = 1;
        })
        .alignItems(HorizontalAlign.Center)

        // AIé¡µé¢æŒ‰é’®
        Column() {
          Image($r('app.media.ic_ai'))
            .width(26)
            .height(26)
            .fillColor(this.selectedIndex === 2 ? '#007AFF' : '#8E8E93')
          Text('AIåŠ©æ‰‹')
            .fontSize(12)
            .fontColor(this.selectedIndex === 2 ? '#007AFF' : '#8E8E93')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .onClick(() => {
          this.selectedIndex = 2;
        })
        .alignItems(HorizontalAlign.Center)
      }

      // AIå¯¹è¯ç•Œé¢æŒ‰é’®
      // å·²æ•´åˆåˆ°åº•éƒ¨å¯¼èˆªæ 

      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 1 }, color: '#E5E5EA' })
    }
    .width('100%')
    .height('100%')
  }
}

// å¡ç‰‡æ ·å¼ç»„ä»¶
@Component
struct Card {
  @BuilderParam content: () => void

  build() {
    Column() {
      this.content()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#0000001A',
      offsetX: 0,
      offsetY: 2
    })
  }
}