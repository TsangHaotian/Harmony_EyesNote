import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { storage } from '../utils/Storage';
import http from '@ohos.net.http';

interface RouterParams {
  content?: string;
  index?: number;
}

interface Message {
  role: string;
  content: string;
}

interface GeneratedTypeLiteralInterface_2 {
  content: string;
}

interface GeneratedTypeLiteralInterface_1 {
  message: GeneratedTypeLiteralInterface_2;
}

@Entry
@Component
struct Index {
  analyzedNote: string = "";
  isAnalyzing: boolean = false;
  @State currentNote: string = '';
  @State historyNotes: string[] = [];
  // é¢„ç½®çš„æ¨¡æ¿åˆ—è¡¨
  @State defaultTemplates: string[] = [
    'ä¼šè®®è®°å½•æ¨¡æ¿ï¼š\n\nä¼šè®®ä¸»é¢˜ï¼š\næ—¶é—´ï¼š\nåœ°ç‚¹ï¼š\nå‚ä¸Žäººå‘˜ï¼š\n\nè®®ç¨‹ï¼š\n1. \n2. \n3. \n\nå¾…åŠžäº‹é¡¹ï¼š',
    'è´­ç‰©æ¸…å•ï¼š\n\nðŸ¥¬ è”¬èœç±»ï¼š\nðŸ¥© è‚‰ç±»ï¼š\nðŸ¥› å¥¶åˆ¶å“ï¼š\nðŸž ä¸»é£Ÿï¼š\nðŸ§¹ æ—¥ç”¨å“ï¼š',
    'å­¦ä¹ è®¡åˆ’ï¼š\n\nðŸ“š ä»Šæ—¥å­¦ä¹ ç›®æ ‡ï¼š\nâ° é¢„è®¡ç”¨æ—¶ï¼š\nðŸ“– é‡ç‚¹å†…å®¹ï¼š\nâœ… å®Œæˆæƒ…å†µï¼š'
  ];
  @State customTemplates: string[] = [];
  @State allTemplates: string[] = [];

  // é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
  async aboutToAppear() {
    // èŽ·å–åº”ç”¨ä¸Šä¸‹æ–‡å¹¶åˆå§‹åŒ–å­˜å‚¨
    const context = getContext(this) as common.UIAbilityContext;
    await storage.init(context);

    // åŠ è½½åŽ†å²ç¬”è®°
    const savedNotes = await storage.getHistoryNotes();
    if (savedNotes.length > 0) {
      this.historyNotes = savedNotes;
    } else {
      // å¦‚æžœæ²¡æœ‰ä¿å­˜çš„ç¬”è®°ï¼Œä½¿ç”¨é»˜è®¤å€¼
      this.historyNotes = ['æ¬¢è¿Žä½¿ç”¨çœ¨çœ¼ç¬”è®°ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿè®°å½•å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è®°å½•æ‚¨çš„æƒ³æ³•'];
    }

    // åŠ è½½å½“å‰ç¬”è®°
    const savedCurrentNote = await storage.getCurrentNote();
    if (savedCurrentNote) {
      this.currentNote = savedCurrentNote;
    }

    // åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿
    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];
  }

  // é¡µé¢è¿”å›žæ—¶å¤„ç†æ•°æ®
  async onPageShow() {
    const result = router.getParams() as RouterParams;
    if (result && result.content !== undefined && result.index !== undefined) {
      const newContent = result.content;
      const index = result.index;
      if (index >= 0 && index < this.historyNotes.length) {
        this.historyNotes[index] = newContent;
        await storage.saveHistoryNotes(this.historyNotes);
      }
    }

    // é‡æ–°åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿
    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];
  }

  // æ‰“å¼€è¯¦æƒ…é¡µ
  openNoteDetail(note: string, index: number) {
    router.pushUrl({
      url: 'pages/NoteDetail',
      params: {
        noteContent: note,
        noteIndex: index
      }
    });
  }

  // ä¿å­˜ç¬”è®°
  async saveNote() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.historyNotes.unshift(this.currentNote.trim());
    this.currentNote = '';

    // ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
    await storage.saveHistoryNotes(this.historyNotes);
    await storage.saveCurrentNote('');
  }

  // åˆ é™¤ç¬”è®°
  async deleteNote(index: number) {
    this.historyNotes.splice(index, 1);
    await storage.saveHistoryNotes(this.historyNotes);
  }

  // AIåˆ†æžç¬”è®°å†…å®¹
  async analyzeNoteWithAI() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.isAnalyzing = true;
    this.analyzedNote = 'æ­£åœ¨åˆ†æžä¸­...';

    const client = http.createHttp();
    try {
      const resp = await client.request(
        'https://api.deepseek.com/v1/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-20faf5c818224258a495651e2d663907'
          },
          extraData: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content:
                'ä½ æ˜¯ã€Œä¸“ä¸šç¬”è®°æ•´ç†åŠ©æ‰‹ + æ³¨å†Œè¥å…»å¸ˆã€ã€‚\n' +
                  '1. å…ˆè¯†åˆ«ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬ç±»åž‹ï¼ˆä¼šè®®/å¾…åŠž/å­¦ä¹ /ä¹°èœ/å…¶ä»–ï¼‰ã€‚\n' +
                  '2. æŒ‰å¯¹åº”æ¨¡æ¿è¾“å‡ºçº¯æ–‡æœ¬ç¬”è®°ï¼Œå±‚çº§ç”¨ã€ã€‘æˆ–â‘ â‘¡â‘¢ï¼Œç¦ç”¨Markdownã€‚\n' +
                  '3. è‹¥ä¿¡æ¯ç¼ºå¤±ï¼Œç›´æŽ¥è¡¥å»ºè®®å¹¶æ ‡æ³¨ã€å¾…ç¡®è®¤ã€‘ã€‚\n' +
                  '4. å½“æ£€æµ‹åˆ°ä¹°èœã€é£Ÿæã€é¥®é£Ÿã€å¥åº·ç›¸å…³å…³é”®è¯ï¼Œç«‹å³åˆ‡æ¢è¥å…»å¸ˆèº«ä»½ï¼š\n' +
                  '   - ç”Ÿæˆå½“å¤©3é¤é£Ÿææ¸…å•ï¼ˆè”¬èœ/è›‹ç™½/ä¸»é£Ÿ/æ°´æžœ/è°ƒå‘³ï¼‰ã€‚\n' +
                  '   - æ ‡æ³¨æ¯äººä»½é‡â‰ˆçƒ­é‡ã€è›‹ç™½è´¨ã€å…³é”®è¥å…»ç´ ã€‚\n' +
                  '   - ç»™å‡ºå‚¨å­˜å°è´´å£«ï¼ˆå†·è—/å†·å†»/å¸¸æ¸©å¤©æ•°ï¼‰ã€‚\n' +
                  '5. è¾“å‡ºç¤ºä¾‹ï¼š\n' +
                  'ã€ä»Šæ—¥3äººé¤é£Ÿææ¸…å•ã€‘\n' +
                  'â‘  è”¬èœï¼šè¥¿å…°èŠ±300gï¼ˆç»´Câ‰ˆ135mgï¼‰\n' +
                  'â‘¡ è›‹ç™½ï¼šåŽ»çš®é¸¡èƒ¸400gï¼ˆè›‹ç™½â‰ˆ92gï¼Œä½Žè„‚ï¼‰\n' +
                  'â‘¢ ä¸»é£Ÿï¼šç³™ç±³200gï¼ˆä½ŽGIï¼‰\n' +
                  'â‘£ æ°´æžœï¼šè“èŽ“150gï¼ˆèŠ±é’ç´ æŠ¤çœ¼ï¼‰\n' +
                  'â‘¤ è°ƒå‘³ï¼šåˆæ¦¨æ©„æ¦„æ²¹20ml\n' +
                  'å‚¨å­˜ï¼šé¸¡èƒ¸åˆ†2è¢‹å†·å†»ï¼Œè”¬èœ3å¤©å†…å†·è—ç”¨å®Œã€‚\n' +
                  'ã€å¾…ç¡®è®¤ã€‘è¯·è¡¥å……ç”¨é¤äººæ•°/å¿Œå£/é¢„ç®—/çƒ¹é¥ªæ–¹å¼ã€‚'
              } as Message,
              {
                role: 'user',
                content: `è¯·æ•´ç†ä»¥ä¸‹ç¬”è®°å†…å®¹ï¼š${this.currentNote}`
              } as Message
            ] as Message[],
            max_tokens: 500
          })
        }
      );

      if (resp.responseCode === 200) {
        interface Body {
          choices: Array<GeneratedTypeLiteralInterface_1>;
        }

        const body: Body = JSON.parse(resp.result.toString());
        this.analyzedNote = body.choices[0].message.content.trim();
        this.currentNote = this.analyzedNote;
      } else {
        this.analyzedNote = `åˆ†æžå¤±è´¥ï¼šHTTPé”™è¯¯ç  ${resp.responseCode}`;
      }
    } catch (err) {
      this.analyzedNote = `åˆ†æžå¤±è´¥ï¼š${JSON.stringify(err)}`;
    } finally {
      this.isAnalyzing = false;
      client.destroy();
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('çœ¨çœ¼ç¬”è®°')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
        Blank()
        Image($r("app.media.ic_setting"))
          .width(24)
          .height(24)
          .onClick(() => {
            router.pushUrl({ url: 'pages/Settings' });
          })
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 12,
        bottom: 12
      })
      .backgroundColor('#f5f5f5')

      Divider().strokeWidth(1).color('#1F000000')

      // æ¨¡æ¿å¡ç‰‡ï¼ˆç½®é¡¶æ˜¾ç¤ºï¼‰
      Column() {
        Text('ðŸ“‹ å¿«é€Ÿæ¨¡æ¿')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.allTemplates, (template: string, index: number) => {
              Column() {
                Text(template)
                  .fontSize(12)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .width('100%')
                  .padding(8)
                Button('ä½¿ç”¨')
                  .width('100%')
                  .height(28)
                  .fontSize(12)
                  .onClick(() => {
                    this.currentNote = template;
                  })
              }
              .width(120)
              .height(100)
              .padding(8)
              .backgroundColor('#FFF0F0F0')
              .borderRadius(8)
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 16, bottom: 8 })

      Divider().strokeWidth(1).color('#1F000000')

      // å½“å‰ç¬”è®°è¾“å…¥åŒº
      Column() {
        Text('å½“å‰ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'å†™ä¸‹ä½ çš„æƒ³æ³•â€¦', text: $$this.currentNote })
          .width('100%')
          .height(100)
          .backgroundColor('#FFECECEC')
          .borderRadius(8)

        Row({ space: 8 }) {
          Button('ä¿å­˜')
            .layoutWeight(1)
            .onClick(() => {
              this.saveNote();
            })

          Button('AIåˆ†æž')
            .layoutWeight(1)
            .backgroundColor('#FF4CAF50')
            .onClick(() => {
              this.analyzeNoteWithAI();
            })
            .enabled(!this.isAnalyzing)
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding(16)

      Divider().strokeWidth(1).color('#1F000000')

      // åŽ†å²ç¬”è®°åˆ—è¡¨
      Column() {
        Text('åŽ†å²ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        List({ space: 8 }) {
          ForEach(this.historyNotes, (note: string, index: number) => {
            ListItem() {
              Row() {
                Text(note)
                  .fontSize(14)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
                Image($r('app.media.ic_delete'))
                  .width(18)
                  .height(18)
                  .onClick(() => {
                    this.deleteNote(index);
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#FFF5F5F5')
              .borderRadius(8)
              .onClick(() => {
                this.openNoteDetail(note, index);
              })
            }
          }, (note: string, index: number) => `${note}_${index}`)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        .scrollBar(BarState.Auto)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 8 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFFFF')
  }
}
