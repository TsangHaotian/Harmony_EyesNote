// Index.ets - ä¸»é¡µé¢ï¼ŒåŒ…å«åº•éƒ¨å¯¼èˆªæ 
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { storage } from '../utils/Storage';
import http from '@ohos.net.http';

interface RouterParams {
  content?: string;
  index?: number;
}

interface Message {
  role: string;
  content: string;
}

interface GeneratedTypeLiteralInterface_2 {
  content: string;
}

interface GeneratedTypeLiteralInterface_1 {
  message: GeneratedTypeLiteralInterface_2;
}

@Entry
@Component
struct Index {
  // åº•éƒ¨å¯¼èˆªæ ç›¸å…³çŠ¶æ€
  @State selectedIndex: number = 0; // 0: ç¬”è®°é¡µé¢, 1: å¥åº·é¡µé¢

  // ç¬”è®°é¡µé¢ç›¸å…³çŠ¶æ€
  analyzedNote: string = "";
  isAnalyzing: boolean = false;
  @State currentNote: string = '';
  @State historyNotes: string[] = [];
  @State defaultTemplates: string[] = [
    'ä¼šè®®è®°å½•æ¨¡æ¿ï¼š\n\nä¼šè®®ä¸»é¢˜ï¼š\næ—¶é—´ï¼š\nåœ°ç‚¹ï¼š\nå‚ä¸Žäººå‘˜ï¼š\n\nè®®ç¨‹ï¼š\n1. \n2. \n3. \n\nå¾…åŠžäº‹é¡¹ï¼š',
    'è´­ç‰©æ¸…å•ï¼š\n\nðŸ¥¬ è”¬èœç±»ï¼š\nðŸ¥© è‚‰ç±»ï¼š\nðŸ¥› å¥¶åˆ¶å“ï¼š\nðŸž ä¸»é£Ÿï¼š\nðŸ§¹ æ—¥ç”¨å“ï¼š',
    'å­¦ä¹ è®¡åˆ’ï¼š\n\nðŸ“š ä»Šæ—¥å­¦ä¹ ç›®æ ‡ï¼š\nâ° é¢„è®¡ç”¨æ—¶ï¼š\nðŸ“– é‡ç‚¹å†…å®¹ï¼š\nâœ… å®Œæˆæƒ…å†µï¼š'
  ];
  @State customTemplates: string[] = [];
  @State allTemplates: string[] = [];

  // å¥åº·é¡µé¢ç›¸å…³çŠ¶æ€
  @State waterCount: number = 0;
  @State sleepHours: number = 7;
  @State stepsCount: number = 0;
  @State mood: string = 'å¼€å¿ƒ';

  // é¡µé¢åŠ è½½æ—¶æ¢å¤æ•°æ®
  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await storage.init(context);

    // åŠ è½½ç¬”è®°æ•°æ®
    const savedNotes = await storage.getHistoryNotes();
    if (savedNotes.length > 0) {
      this.historyNotes = savedNotes;
    } else {
      this.historyNotes = ['æ¬¢è¿Žä½¿ç”¨çœ¨çœ¼ç¬”è®°ï¼Œè¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿè®°å½•å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©æ‚¨è®°å½•æ‚¨çš„æƒ³æ³•'];
    }

    const savedCurrentNote = await storage.getCurrentNote();
    if (savedCurrentNote) {
      this.currentNote = savedCurrentNote;
    }

    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];
  }

  // é¡µé¢è¿”å›žæ—¶å¤„ç†æ•°æ®
  async onPageShow() {
    const result = router.getParams() as RouterParams;
    if (result && result.content !== undefined && result.index !== undefined) {
      const newContent = result.content;
      const index = result.index;
      if (index >= 0 && index < this.historyNotes.length) {
        this.historyNotes[index] = newContent;
        await storage.saveHistoryNotes(this.historyNotes);
      }
    }

    const savedCustomTemplates = await storage.getCustomTemplates();
    this.customTemplates = savedCustomTemplates;
    this.allTemplates = [...this.defaultTemplates, ...this.customTemplates];
  }

  // ç¬”è®°é¡µé¢æ–¹æ³•
  openNoteDetail(note: string, index: number) {
    router.pushUrl({
      url: 'pages/NoteDetail',
      params: {
        noteContent: note,
        noteIndex: index
      }
    });
  }

  async saveNote() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.historyNotes.unshift(this.currentNote.trim());
    this.currentNote = '';

    await storage.saveHistoryNotes(this.historyNotes);
    await storage.saveCurrentNote('');
  }

  async deleteNote(index: number) {
    this.historyNotes.splice(index, 1);
    await storage.saveHistoryNotes(this.historyNotes);
  }

  async analyzeNoteWithAI() {
    if (this.currentNote.trim().length === 0) {
      return;
    }

    this.isAnalyzing = true;
    this.analyzedNote = 'æ­£åœ¨åˆ†æžä¸­...';

    const client = http.createHttp();
    try {
      const resp = await client.request(
        'https://api.deepseek.com/v1/chat/completions',
        {
          method: http.RequestMethod.POST,
          header: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer sk-20faf5c818224258a495651e2d663907'
          },
          extraData: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¬”è®°æ•´ç†åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·è¾“å…¥çš„æ‚ä¹±æ–‡å­—æ•´ç†æˆç»“æž„æ¸…æ™°ã€æ ¼å¼è§„èŒƒçš„ç¬”è®°ã€‚æ ¹æ®å†…å®¹ç±»åž‹é€‰æ‹©åˆé€‚çš„æ¨¡æ¿ï¼Œå¦‚ä¼šè®®è®°å½•ã€å¾…åŠžäº‹é¡¹ã€å­¦ä¹ ç¬”è®°ç­‰ã€‚ä¿æŒåŽŸæ„ï¼Œä½†è®©æ ¼å¼æ›´è§„èŒƒæ˜“è¯»ã€‚'
              } as Message,
              {
                role: 'user',
                content: `è¯·æ•´ç†ä»¥ä¸‹ç¬”è®°å†…å®¹ï¼š${this.currentNote}`
              } as Message
            ] as Message[],
            max_tokens: 500
          })
        }
      );

      if (resp.responseCode === 200) {
        interface Body {
          choices: Array<GeneratedTypeLiteralInterface_1>;
        }
        const body: Body = JSON.parse(resp.result.toString());
        this.analyzedNote = body.choices[0].message.content.trim();
        this.currentNote = this.analyzedNote;
      } else {
        this.analyzedNote = `åˆ†æžå¤±è´¥ï¼šHTTPé”™è¯¯ç  ${resp.responseCode}`;
      }
    } catch (err) {
      this.analyzedNote = `åˆ†æžå¤±è´¥ï¼š${JSON.stringify(err)}`;
    } finally {
      this.isAnalyzing = false;
      client.destroy();
    }
  }

  // å¥åº·é¡µé¢æ–¹æ³•
  incrementWater() {
    this.waterCount += 1;
  }

  decrementWater() {
    if (this.waterCount > 0) {
      this.waterCount -= 1;
    }
  }

  incrementSteps() {
    this.stepsCount += 100;
  }

  decrementSteps() {
    if (this.stepsCount >= 100) {
      this.stepsCount -= 100;
    }
  }

  changeSleep(hours: number) {
    this.sleepHours = Math.max(1, Math.min(12, this.sleepHours + hours));
  }

  changeMood(newMood: string) {
    this.mood = newMood;
  }

  // ç¬”è®°é¡µé¢UI
  @Builder
  NotePage() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('çœ¨çœ¼ç¬”è®°')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
        Blank()
        Image($r("app.media.ic_setting"))
          .width(24)
          .height(24)
          .onClick(() => {
            router.pushUrl({ url: 'pages/Settings' });
          })
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 12,
        bottom: 12
      })
      .backgroundColor('#f5f5f5')

      Divider().strokeWidth(1).color('#1F000000')

      // æ¨¡æ¿å¡ç‰‡
      Column() {
        Text('ðŸ“‹ å¿«é€Ÿæ¨¡æ¿')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.allTemplates, (template: string, index: number) => {
              Column() {
                Text(template)
                  .fontSize(12)
                  .maxLines(3)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .width('100%')
                  .padding(8)
                Button('ä½¿ç”¨')
                  .width('100%')
                  .height(28)
                  .fontSize(12)
                  .onClick(() => {
                    this.currentNote = template;
                  })
              }
              .width(120)
              .height(100)
              .padding(8)
              .backgroundColor('#FFF0F0F0')
              .borderRadius(8)
            })
          }
          .padding({ left: 16, right: 16 })
        }
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 16, bottom: 8 })

      Divider().strokeWidth(1).color('#1F000000')

      // å½“å‰ç¬”è®°è¾“å…¥åŒº
      Column() {
        Text('å½“å‰ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        TextInput({ placeholder: 'å†™ä¸‹ä½ çš„æƒ³æ³•â€¦', text: $$this.currentNote })
          .width('100%')
          .height(100)
          .backgroundColor('#FFECECEC')
          .borderRadius(8)

        Row({ space: 8 }) {
          Button('ä¿å­˜')
            .layoutWeight(1)
            .onClick(() => {
              this.saveNote();
            })

          Button('AIåˆ†æž')
            .layoutWeight(1)
            .backgroundColor('#FF4CAF50')
            .onClick(() => {
              this.analyzeNoteWithAI();
            })
            .enabled(!this.isAnalyzing)
        }
        .width('100%')
        .margin({ top: 8 })
      }
      .padding(16)

      Divider().strokeWidth(1).color('#1F000000')

      // åŽ†å²ç¬”è®°åˆ—è¡¨
      Column() {
        Text('åŽ†å²ç¬”è®°')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .margin({ bottom: 8 })

        List({ space: 8 }) {
          ForEach(this.historyNotes, (note: string, index: number) => {
            ListItem() {
              Row() {
                Text(note)
                  .fontSize(14)
                  .maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
                  .layoutWeight(1)
                Image($r('app.media.ic_delete'))
                  .width(18)
                  .height(18)
                  .onClick(() => {
                    this.deleteNote(index);
                  })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#FFF5F5F5')
              .borderRadius(8)
              .onClick(() => {
                this.openNoteDetail(note, index);
              })
            }
          }, (note: string, index: number) => `${note}_${index}`)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        .scrollBar(BarState.Auto)
        .edgeEffect(EdgeEffect.Spring)
      }
      .padding({ top: 8 })
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFFFFFFF')
  }

  // å¥åº·é¡µé¢UI
  @Builder
  HealthPage() {
    Scroll() {
      Column({ space: 16 }) {
        // é¡¶éƒ¨æ ‡é¢˜
        Text('å¥åº·è¿½è¸ª')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 10 })

        // é¥®æ°´è¿½è¸ª
        Card() {
          Column({ space: 12 }) {
            Text('ðŸ’§ ä»Šæ—¥é¥®æ°´')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.waterCount} æ¯`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#007AFF')

            Row({ space: 20 }) {
              Button('-')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick(() => this.decrementWater())

              Button('+')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick(() => this.incrementWater())
            }
          }
          .width('100%')
          .padding(20)
        }

        // ç¡çœ è®°å½•
        Card() {
          Column({ space: 12 }) {
            Text('ðŸ˜´ ç¡çœ æ—¶é—´')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.sleepHours} å°æ—¶`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#34C759')

            Row({ space: 20 }) {
              Button('-')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick(() => this.changeSleep(-1))

              Button('+')
                .width(40)
                .height(40)
                .borderRadius(20)
                .onClick(() => this.changeSleep(1))
            }
          }
          .width('100%')
          .padding(20)
        }

        // æ­¥æ•°ç»Ÿè®¡
        Card() {
          Column({ space: 12 }) {
            Text('ðŸš¶ ä»Šæ—¥æ­¥æ•°')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(`${this.stepsCount} æ­¥`)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FF9500')

            Row({ space: 20 }) {
              Button('-100')
                .width(60)
                .height(40)
                .borderRadius(20)
                .fontSize(12)
                .onClick(() => this.decrementSteps())

              Button('+100')
                .width(60)
                .height(40)
                .borderRadius(20)
                .fontSize(12)
                .onClick(() => this.incrementSteps())
            }
          }
          .width('100%')
          .padding(20)
        }

        // å¿ƒæƒ…è®°å½•
        Card() {
          Column({ space: 12 }) {
            Text('ðŸ˜Š ä»Šæ—¥å¿ƒæƒ…')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)

            Text(this.mood)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#AF52DE')

            Row({ space: 10 }) {
              ForEach(['å¼€å¿ƒ', 'å¹³é™', 'ç–²æƒ«', 'ç„¦è™‘', 'å…´å¥‹'], (moodOption: string) => {
                Button(moodOption)
                  .height(35)
                  .borderRadius(18)
                  .fontSize(12)
                  .backgroundColor(this.mood === moodOption ? '#AF52DE' : '#E5E5EA')
                  .onClick(() => this.changeMood(moodOption))
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceEvenly)
          }
          .width('100%')
          .padding(20)
        }
      }
      .padding(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF5F5F5')
  }

  build() {
    Column() {
      // ä¸»å†…å®¹åŒºåŸŸ
      Stack() {
        if (this.selectedIndex === 0) {
          this.NotePage()
        } else {
          this.HealthPage()
        }
      }
      .layoutWeight(1)

      // åº•éƒ¨å¯¼èˆªæ 
      Row() {
        // ç¬”è®°é¡µé¢æŒ‰é’®
        Column() {
          Image($r('app.media.ic_edit'))
            .width(24)
            .height(24)
            .fillColor(this.selectedIndex === 0 ? '#007AFF' : '#8E8E93')
          Text('ç¬”è®°')
            .fontSize(12)
            .fontColor(this.selectedIndex === 0 ? '#007AFF' : '#8E8E93')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .onClick(() => {
          this.selectedIndex = 0;
        })
        .alignItems(HorizontalAlign.Center)

        // å¥åº·é¡µé¢æŒ‰é’®
        Column() {
          Image($r('app.media.ic_right'))
            .width(24)
            .height(24)
            .fillColor(this.selectedIndex === 1 ? '#007AFF' : '#8E8E93')
          Text('å¥åº·')
            .fontSize(12)
            .fontColor(this.selectedIndex === 1 ? '#007AFF' : '#8E8E93')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .onClick(() => {
          this.selectedIndex = 1;
        })
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FFFFFF')
      .border({
        width: { top: 1 },
        color: '#E5E5EA'
      })
    }
    .width('100%')
    .height('100%')
  }
}

// å¡ç‰‡æ ·å¼ç»„ä»¶
@Component
struct Card {
  @BuilderParam content: () => void

  build() {
    Column() {
      this.content()
    }
    .width('100%')
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .shadow({
      radius: 8,
      color: '#0000001A',
      offsetX: 0,
      offsetY: 2
    })
  }
}