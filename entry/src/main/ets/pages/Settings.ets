import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { storage } from '../utils/Storage';
import promptAction from '@ohos.promptAction';
import { ThemePreset } from '../utils/Types';
import { DEFAULT_THEME_ID, ThemeColorKey, cloneThemePresets, getThemeById, getThemeColorValue } from '../utils/Theme';

@Entry
@Component
struct Settings {
  @State themePresets: ThemePreset[] = cloneThemePresets();
  @State selectedThemeId: string = DEFAULT_THEME_ID;
  @State showThemeSelector: boolean = false;
  @State themeSelectorOpacity: number = 0; // ‰∏ªÈ¢òÂàóË°®ÈÄèÊòéÂ∫¶
  @State themeSelectorOffset: number = -8; // ‰∏ªÈ¢òÂàóË°®‰ΩçÁßª
  @State themeArrowAngle: number = 0; // ÁÆ≠Â§¥ÊóãËΩ¨ËßíÂ∫¶

  getCurrentTheme(): ThemePreset {
    return getThemeById(this.selectedThemeId, this.themePresets);
  }

  getThemeColor(key: ThemeColorKey): string {
    return getThemeColorValue(this.getCurrentTheme(), key);
  }

  async aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    await storage.init(context);
    this.themePresets = cloneThemePresets();
    const savedThemeId = await storage.getThemePreference();
    if (savedThemeId) {
      const exists = this.themePresets.some((theme: ThemePreset) => theme.id === savedThemeId);
      this.selectedThemeId = exists ? savedThemeId : DEFAULT_THEME_ID;
    }
  }

  async selectTheme(themeId: string) {
    this.selectedThemeId = themeId;
    await storage.saveThemePreference(themeId);
    const themeName = this.themePresets.find((theme: ThemePreset) => theme.id === themeId)?.name || '';
    promptAction.showToast({
      message: `Â∑≤ÂàáÊç¢‰∏ªÈ¢òÔºö${themeName}`,
      duration: 1500
    });
    this.animateThemeSelectorVisibility(false);
  }

  toggleThemeSelector() {
    this.animateThemeSelectorVisibility(!this.showThemeSelector);
  }

  animateThemeSelectorVisibility(show: boolean) {
    if (show) {
      if (this.showThemeSelector) {
        return;
      }
      this.showThemeSelector = true;
      this.themeSelectorOpacity = 0;
      this.themeSelectorOffset = -8;
      animateTo({
        duration: 220,
        curve: 'linear'
      }, () => {
        this.themeSelectorOpacity = 1;
        this.themeSelectorOffset = 0;
        this.themeArrowAngle = 90;
      });
    } else {
      if (!this.showThemeSelector) {
        return;
      }
      animateTo({
        duration: 200,
        curve: 'linear'
      }, () => {
        this.themeSelectorOpacity = 0;
        this.themeSelectorOffset = -8;
        this.themeArrowAngle = 0;
      });
      setTimeout(() => {
        this.showThemeSelector = false;
      }, 210);
    }
  }

  async exportData() {
    try {
      const data = await storage.exportAllData();
      promptAction.showDialog({
        title: 'Êï∞ÊçÆÂØºÂá∫',
        message: `Êï∞ÊçÆÂ∑≤ÂØºÂá∫ÔºåÂÖ±${data.length}Â≠óÁ¨¶\n\nÊï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞ÊéßÂà∂Âè∞ÔºåÂèØÂú®ÂºÄÂèëËÄÖÂ∑•ÂÖ∑‰∏≠Êü•Áúã`,
        buttons: [{ text: 'Á°ÆÂÆö', color: '#007AFF' }]
      });
      console.log('=== ÂØºÂá∫Êï∞ÊçÆÂºÄÂßã ===');
      console.log(data);
      console.log('=== ÂØºÂá∫Êï∞ÊçÆÁªìÊùü ===');
    } catch (error) {
      promptAction.showToast({
        message: 'ÂØºÂá∫Â§±Ë¥•',
        duration: 2000
      });
    }
  }

  async clearAllData() {
    promptAction.showDialog({
      title: 'Âç±Èô©Êìç‰Ωú',
      message: 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ',
      buttons: [
        { text: 'ÂèñÊ∂à', color: '#666666' },
        { text: 'Ê∏ÖÁ©∫', color: '#FF3B30' }
      ]
    }).then((result) => {
      if (result.index === 1) {
        storage.clearAllData().then(() => {
          promptAction.showToast({
            message: 'Êï∞ÊçÆÂ∑≤Ê∏ÖÁ©∫',
            duration: 2000
          });
        }).catch((err: Error) => {
          promptAction.showToast({
            message: 'Ê∏ÖÁ©∫Â§±Ë¥•',
            duration: 2000
          });
        });
      }
    }).catch((err: Error) => {
      console.error(`Ê∏ÖÁ©∫Êï∞ÊçÆÂØπËØùÊ°ÜÈîôËØØ: ${err}`);
    });
  }

  build() {
    Column() {
      // È°∂ÈÉ®ÂØºËà™Ê†è
      Row() {
        Image($r('app.media.ic_backup'))
          .width(28)
          .height(28)
          .padding(4)
          .margin({ right: 12 })
          .onClick(() => {
            router.back();
          })
        Text('ÂÖ≥‰∫éÊàë‰ª¨')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.getThemeColor('textColor'))
        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })
      .backgroundColor(this.getThemeColor('backgroundColor'))

      Divider().strokeWidth(0.5).color('#E5E5EA')

      Scroll() {
        Column({ space: 16 }) {
          // Êï∞ÊçÆÁÆ°ÁêÜÊ†áÈ¢ò
          Text('Êï∞ÊçÆÁÆ°ÁêÜ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getThemeColor('textColor'))
            .width('100%')
            .margin({ bottom: 8 })

          // Êï∞ÊçÆÁªüËÆ°
          Row() {
            Text('üìä Êï∞ÊçÆÁªüËÆ°')
              .fontSize(16)
              .fontColor(this.getThemeColor('textColor'))
            Blank()
            Image($r('app.media.ic_right'))
              .width(20)
              .height(20)
              .fillColor(this.getThemeColor('mutedTextColor'))
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })
          .onClick(() => {
            router.pushUrl({ url: 'pages/Statistics' });
          })

          // ÂØºÂá∫Êï∞ÊçÆ
          Row() {
            Text('üì§ ÂØºÂá∫Êï∞ÊçÆ')
              .fontSize(16)
              .fontColor(this.getThemeColor('textColor'))
            Blank()
            Image($r('app.media.ic_right'))
              .width(20)
              .height(20)
              .fillColor(this.getThemeColor('mutedTextColor'))
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })
          .onClick(() => {
            this.exportData();
          })

          // Ê∏ÖÁ©∫Êï∞ÊçÆ
          Row() {
            Text('üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ')
              .fontSize(16)
              .fontColor('#FF3B30')
            Blank()
            Image($r('app.media.ic_right'))
              .width(20)
              .height(20)
              .fillColor('#FF3B30')
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })
          .onClick(() => {
            this.clearAllData();
          })

          Divider()
            .strokeWidth(0.5)
            .color('#E5E5EA')
            .margin({ top: 16, bottom: 16 })

          // ‰∏ªÈ¢òÈ£éÊ†º
          Text('‰∏ªÈ¢òÈ£éÊ†º')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getThemeColor('textColor'))
            .width('100%')
            .margin({ bottom: 8 })

          Row() {
            Column({ space: 4 }) {
              Text('ÂΩìÂâç‰∏ªÈ¢ò')
                .fontSize(14)
                .fontColor(this.getThemeColor('mutedTextColor'))
              Text(this.themePresets.find((theme: ThemePreset) => theme.id === this.selectedThemeId)?.name || 'ÈªòËÆ§')
                .fontSize(16)
                .fontColor(this.getThemeColor('textColor'))
                .fontWeight(FontWeight.Medium)
            }
            Blank()
            Image($r('app.media.ic_backup2'))
              .width(20)
              .height(20)
              .fillColor('#666666')
              .rotate({ angle: this.themeArrowAngle })
          }
          .width('100%')
          .height(72)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })
          .onClick(() => {
            this.toggleThemeSelector();
          })

          if (this.showThemeSelector || this.themeSelectorOpacity > 0) {
            Column({ space: 12 }) {
              ForEach(this.themePresets, (theme: ThemePreset) => {
                Row() {
                  Column({ space: 6 }) {
                    Text(theme.name)
                      .fontSize(16)
                      .fontColor(this.getThemeColor('textColor'))
                      .fontWeight(FontWeight.Medium)
                    Row({ space: 8 }) {
                      Text(`ËÉåÊôØ ${theme.backgroundColor}`)
                        .fontSize(12)
                        .fontColor(this.getThemeColor('mutedTextColor'))
                      Text(`Âº∫Ë∞É ${theme.accentColor}`)
                        .fontSize(12)
                        .fontColor(this.getThemeColor('mutedTextColor'))
                    }
                  }
                  Blank()
                  if (this.selectedThemeId === theme.id) {
                    Text('‚úì')
                      .fontSize(18)
                      .fontColor(theme.accentColor)
                  } else {
                    Row()
                      .width(18)
                      .height(18)
                      .borderRadius(9)
                      .border({ width: 1, color: '#E5E7EB' })
                      .backgroundColor(this.getThemeColor('cardColor'))
                  }
                }
                .width('100%')
                .height(72)
                .padding({ left: 20, right: 20 })
                .borderRadius(12)
                .backgroundColor(this.getThemeColor('cardColor'))
                .border({
                  width: 1,
                  color: this.selectedThemeId === theme.id ? theme.accentColor : '#F1F5F9'
                })
                .onClick(() => {
                  this.selectTheme(theme.id);
                })
              }, (theme: ThemePreset) => theme.id)
            }
            .width('100%')
            .padding({ top: 12, bottom: 4 })
            .opacity(this.themeSelectorOpacity)
            .translate({ y: this.themeSelectorOffset })
          }

          Divider()
            .strokeWidth(0.5)
            .color('#E5E5EA')
            .margin({ top: 16, bottom: 16 })

          // ÂÖ≥‰∫éÊ†áÈ¢ò
          Text('ÂÖ≥‰∫éÂ∫îÁî®')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.getThemeColor('textColor'))
            .width('100%')
            .margin({ bottom: 8 })

          // ÁâàÊú¨Âè∑
          Row() {
            Text('ÁâàÊú¨Âè∑')
              .fontSize(16)
              .fontColor(this.getThemeColor('textColor'))
            Blank()
            Text('V1.0.0')
              .fontSize(16)
              .fontColor(this.getThemeColor('mutedTextColor'))
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })

          // ÂºÄÂèëËÄÖ
          Row() {
            Text('ÂºÄÂèëËÄÖ')
              .fontSize(16)
              .fontColor(this.getThemeColor('textColor'))
            Blank()
            Text('TsangHaotian')
              .fontSize(16)
              .fontColor(this.getThemeColor('mutedTextColor'))
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })

          // ËÅîÁ≥ªÈÇÆÁÆ±
          Row() {
            Text('ËÅîÁ≥ªÈÇÆÁÆ±')
              .fontSize(16)
              .fontColor(this.getThemeColor('textColor'))
            Blank()
            Text('TsangHaotian@hotmail.com')
              .fontSize(12)
              .fontColor(this.getThemeColor('mutedTextColor'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .constraintSize({ maxWidth: '60%' })
          }
          .width('100%')
          .height(56)
          .padding({ left: 20, right: 20 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })

          // È°πÁõÆÂºÄÊ∫êÂú∞ÂùÄ
          Column({ space: 8 }) {
          Row() {
            Text('È°πÁõÆÂºÄÊ∫êÂú∞ÂùÄ')
                .fontSize(16)
                .fontColor(this.getThemeColor('textColor'))
            Blank()
            }
            .width('100%')
            Text('https://github.com/TsangHaotian/Harmony_EyesNote')
              .fontSize(14)
              .fontColor(this.getThemeColor('accentColor'))
              .width('100%')
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .width('100%')
          .padding({ left: 20, right: 20, top: 16, bottom: 16 })
          .borderRadius(12)
          .backgroundColor(this.getThemeColor('cardColor'))
          .shadow({
            radius: 2,
            color: '#00000006',
            offsetX: 0,
            offsetY: 1
          })

        }
        .width('100%')
        .padding({ top: 24, left: 20, right: 20, bottom: 24 })
      }
      .layoutWeight(1)
      .width('100%')
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
      .backgroundColor(this.getThemeColor('backgroundColor'))
  }
}