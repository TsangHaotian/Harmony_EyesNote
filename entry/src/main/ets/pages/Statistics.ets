import router from '@ohos.router';
import { storage } from '../utils/Storage';
import { StatisticsData, DailyHealthRecord, HealthScore, HealthAnalysis } from '../utils/Types';
import { HealthCalculator } from '../utils/HealthCalculator';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct Statistics {
  @State statisticsData: StatisticsData = {
    totalNotes: 0,
    totalWords: 0,
    avgWaterCount: 0,
    avgSleepHours: 0,
    avgStepsCount: 0,
    healthRecordsCount: 0,
    mostCommonMood: 'å¼€å¿ƒ'
  };
  @State recentRecords: DailyHealthRecord[] = [];
  @State isLoading: boolean = true;
  @State healthScore: HealthScore | null = null;
  @State healthAnalysis: HealthAnalysis | null = null;

  async aboutToAppear() {
    await this.loadData();
  }

  async loadData() {
    this.isLoading = true;
    try {
      this.statisticsData = await storage.getStatisticsData();
      const allRecords = await storage.getDailyHealthRecords();
      // æŒ‰æ—¥æœŸå€’åºæŽ’åˆ—ï¼Œå–æœ€è¿‘7æ¡
      this.recentRecords = allRecords
        .sort((a, b) => b.date.localeCompare(a.date))
        .slice(0, 7);
      
      // åŠ è½½å¥åº·è¯„åˆ†å’Œåˆ†æž
      this.healthScore = await storage.getHealthScore();
      this.healthAnalysis = await storage.getHealthAnalysis();
    } catch (error) {
      console.error(`åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error}`);
      promptAction.showToast({
        message: 'åŠ è½½æ•°æ®å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  async exportData() {
    try {
      const data = await storage.exportAllData();
      promptAction.showToast({
        message: `æ•°æ®å·²å¯¼å‡ºï¼Œå…±${data.length}å­—ç¬¦\nå¯åœ¨è®¾ç½®é¡µé¢æŸ¥çœ‹å¯¼å‡ºé€‰é¡¹`,
        duration: 3000
      });
      console.log('å¯¼å‡ºæ•°æ®:', data);
    } catch (error) {
      promptAction.showToast({
        message: 'å¯¼å‡ºå¤±è´¥',
        duration: 2000
      });
    }
  }

  @Builder
  renderScoreItem(label: string, score: number, color: string) {
    Row() {
      Text(label)
        .fontSize(14)
        .fontColor($r("app.color.TextColor"))
      Blank()
      Row({ space: 8 }) {
        Text(`${score}`)
          .fontSize(16)
          .fontColor(color)
          .fontWeight(FontWeight.Medium)
        Text('/25')
          .fontSize(12)
          .fontColor('#666666')
      }
    }
    .width('100%')
    .padding({ top: 4, bottom: 4 })
  }

  @Builder
  renderHealthScore(totalScore: number) {
    Column({ space: 8 }) {
      Text(`${totalScore}`)
        .fontSize(48)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getHealthLevelColor(totalScore))
      Text(this.getHealthLevelText(totalScore))
        .fontSize(16)
        .fontColor(this.getHealthLevelColor(totalScore))
        .fontWeight(FontWeight.Medium)
      Text(this.getHealthLevelDescription(totalScore))
        .fontSize(12)
        .fontColor('#666666')
        .margin({ top: 4 })
    }
    .width('100%')
    .padding({ top: 12, bottom: 12 })
    .alignItems(HorizontalAlign.Center)
  }

  private getHealthLevelColor(score: number): string {
    const healthLevel = HealthCalculator.getHealthLevel(score);
    return healthLevel.color;
  }

  private getHealthLevelText(score: number): string {
    const healthLevel = HealthCalculator.getHealthLevel(score);
    return healthLevel.level;
  }

  private getHealthLevelDescription(score: number): string {
    const healthLevel = HealthCalculator.getHealthLevel(score);
    return healthLevel.description;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Image($r('app.media.ic_backup'))
          .width(28)
          .height(28)
          .padding(4)
          .margin({ right: 12 })
          .onClick(() => {
            router.back();
          })
        Text('æ•°æ®ç»Ÿè®¡')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r("app.color.TextColor"))
        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 20, right: 20, top: 8, bottom: 8 })
      .backgroundColor($r("app.color.backgroundColor"))

      Divider().strokeWidth(0.5).color('#E5E5EA')

      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .margin({ top: 100 })
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 16 })
        }
        .width('100%')
        .layoutWeight(1)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            // ç¬”è®°ç»Ÿè®¡
            Card() {
              Column({ space: 12 }) {
                Text('ðŸ“ ç¬”è®°ç»Ÿè®¡')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r("app.color.TextColor"))
                
                Row() {
                  Column({ space: 4 }) {
                    Text(`${this.statisticsData.totalNotes}`)
                      .fontSize(32)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#007AFF')
                    Text('æ€»ç¬”è®°æ•°')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .layoutWeight(1)
                  
                  Column({ space: 4 }) {
                    Text(`${this.statisticsData.totalWords}`)
                      .fontSize(32)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#34C759')
                    Text('æ€»å­—æ•°')
                      .fontSize(14)
                      .fontColor('#666666')
                  }
                  .layoutWeight(1)
                }
                .width('100%')
                .padding({ top: 8 })
              }
              .width('100%')
              .padding(24)
            }

            // å¥åº·ç»Ÿè®¡
            Card() {
              Column({ space: 12 }) {
                Text('ðŸ’ª å¥åº·ç»Ÿè®¡')
                  .fontSize(18)
                  .fontWeight(FontWeight.Medium)
                  .fontColor($r("app.color.TextColor"))
                
                Row() {
                  Column({ space: 4 }) {
                    Text(`${this.statisticsData.avgWaterCount}`)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#007AFF')
                    Text('å¹³å‡é¥®æ°´é‡/å¤©')
                      .fontSize(12)
                      .fontColor('#666666')
                  }
                  .layoutWeight(1)
                  
                  Column({ space: 4 }) {
                    Text(`${this.statisticsData.avgSleepHours}`)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#34C759')
                    Text('å¹³å‡ç¡çœ /å°æ—¶')
                      .fontSize(12)
                      .fontColor('#666666')
                  }
                  .layoutWeight(1)
                  
                  Column({ space: 4 }) {
                    Text(`${Math.floor(this.statisticsData.avgStepsCount / 1000)}k`)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#FF9500')
                    Text('å¹³å‡æ­¥æ•°')
                      .fontSize(12)
                      .fontColor('#666666')
                  }
                  .layoutWeight(1)
                }
                .width('100%')
                .padding({ top: 8 })

                Divider()
                  .strokeWidth(0.5)
                  .color('#E5E5EA')
                  .margin({ top: 12, bottom: 8 })

                Row() {
                  Text('è®°å½•å¤©æ•°')
                    .fontSize(14)
                    .fontColor('#666666')
                  Blank()
                  Text(`${this.statisticsData.healthRecordsCount} å¤©`)
                    .fontSize(16)
                    .fontColor($r("app.color.TextColor"))
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')

                Row() {
                  Text('æœ€å¸¸è§å¿ƒæƒ…')
                    .fontSize(14)
                    .fontColor('#666666')
                  Blank()
                  Text(this.statisticsData.mostCommonMood)
                    .fontSize(16)
                    .fontColor('#AF52DE')
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .margin({ top: 8 })
              }
              .width('100%')
              .padding(24)
            }

            // å¥åº·è¯„åˆ†
            if (this.healthScore) {
              Card() {
                Column({ space: 12 }) {
                  Text('â­ ä»Šæ—¥å¥åº·è¯„åˆ†')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r("app.color.TextColor"))
                  
                  // æ€»åˆ†æ˜¾ç¤º
                  this.renderHealthScore(this.healthScore.totalScore)

                  Divider()
                    .strokeWidth(0.5)
                    .color('#E5E5EA')
                    .margin({ top: 8, bottom: 8 })

                  // å„é¡¹å¾—åˆ†
                  Column({ space: 8 }) {
                    this.renderScoreItem('ðŸ’§ é¥®æ°´', this.healthScore.waterScore, '#007AFF')
                    this.renderScoreItem('ðŸ˜´ ç¡çœ ', this.healthScore.sleepScore, '#34C759')
                    this.renderScoreItem('ðŸš¶ æ­¥æ•°', this.healthScore.stepsScore, '#FF9500')
                    this.renderScoreItem('ðŸ˜Š å¿ƒæƒ…', this.healthScore.moodScore, '#AF52DE')
                  }
                  .width('100%')

                  // æ”¹è¿›å»ºè®®
                  if (this.healthScore.suggestions.length > 0) {
                    Divider()
                      .strokeWidth(0.5)
                      .color('#E5E5EA')
                      .margin({ top: 12, bottom: 8 })
                    
                    Column({ space: 6 }) {
                      Text('ðŸ’¡ æ”¹è¿›å»ºè®®')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor($r("app.color.TextColor"))
                        .width('100%')
                      
                      ForEach(this.healthScore.suggestions, (suggestion: string, index: number) => {
                        Text(`â€¢ ${suggestion}`)
                          .fontSize(13)
                          .fontColor('#666666')
                          .width('100%')
                          .lineHeight(20)
                      }, (suggestion: string, index: number) => `${index}`)
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                  }
                }
                .width('100%')
                .padding(24)
              }
            }

            // å¥åº·åˆ†æž
            if (this.healthAnalysis) {
              Card() {
                Column({ space: 12 }) {
                  Text('ðŸ“Š å¥åº·åˆ†æž')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r("app.color.TextColor"))
                  
                  // è¶‹åŠ¿
                  Row() {
                    Text('è¶‹åŠ¿')
                      .fontSize(14)
                      .fontColor('#666666')
                    Blank()
                    Text(this.healthAnalysis.trend)
                      .fontSize(14)
                      .fontColor(this.healthAnalysis.trend === 'ä¸Šå‡' ? '#34C759' : 
                                this.healthAnalysis.trend === 'ä¸‹é™' ? '#FF3B30' : '#666666')
                      .fontWeight(FontWeight.Medium)
                  }
                  .width('100%')

                  // æ´žå¯Ÿ
                  if (this.healthAnalysis.insights.length > 0) {
                    Column({ space: 6 }) {
                      Text('ðŸ“ˆ æ•°æ®æ´žå¯Ÿ')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor($r("app.color.TextColor"))
                        .width('100%')
                        .margin({ top: 8 })
                      
                      ForEach(this.healthAnalysis.insights, (insight: string, index: number) => {
                        Text(`â€¢ ${insight}`)
                          .fontSize(13)
                          .fontColor('#666666')
                          .width('100%')
                          .lineHeight(20)
                      }, (insight: string, index: number) => `${index}`)
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                  }

                  // æŽ¨è
                  if (this.healthAnalysis.recommendations.length > 0) {
                    Column({ space: 6 }) {
                      Text('ðŸ’¡ ä¸ªæ€§åŒ–æŽ¨è')
                        .fontSize(14)
                        .fontWeight(FontWeight.Medium)
                        .fontColor($r("app.color.TextColor"))
                        .width('100%')
                        .margin({ top: 8 })
                      
                      ForEach(this.healthAnalysis.recommendations, (rec: string, index: number) => {
                        Text(`â€¢ ${rec}`)
                          .fontSize(13)
                          .fontColor('#666666')
                          .width('100%')
                          .lineHeight(20)
                      }, (rec: string, index: number) => `${index}`)
                    }
                    .width('100%')
                    .alignItems(HorizontalAlign.Start)
                  }
                }
                .width('100%')
                .padding(24)
              }
            }

            // æœ€è¿‘è®°å½•
            if (this.recentRecords.length > 0) {
              Card() {
                Column({ space: 12 }) {
                  Text('ðŸ“… æœ€è¿‘7å¤©è®°å½•')
                    .fontSize(18)
                    .fontWeight(FontWeight.Medium)
                    .fontColor($r("app.color.TextColor"))
                  
                  Column({ space: 8 }) {
                    ForEach(this.recentRecords, (record: DailyHealthRecord) => {
                      Row() {
                        Column({ space: 4 }) {
                          Text(record.date)
                            .fontSize(14)
                            .fontColor($r("app.color.TextColor"))
                            .fontWeight(FontWeight.Medium)
                          Text(`ðŸ’§${record.waterCount}æ¯  ðŸ˜´${record.sleepHours}h  ðŸš¶${record.stepsCount}æ­¥`)
                            .fontSize(12)
                            .fontColor('#666666')
                        }
                        .layoutWeight(1)
                        Text(record.mood)
                          .fontSize(14)
                          .fontColor('#AF52DE')
                      }
                      .width('100%')
                      .padding({ top: 8, bottom: 8 })
                    }, (record: DailyHealthRecord) => record.date)
                  }
                }
                .width('100%')
                .padding(24)
              }
            }

            // æ•°æ®å¯¼å‡ºæŒ‰é’®
            Button('å¯¼å‡ºæ‰€æœ‰æ•°æ®')
              .width('100%')
              .height(50)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .backgroundColor('#007AFF')
              .borderRadius(25)
              .onClick(() => {
                this.exportData();
              })
              .margin({ top: 8 })
          }
          .width('100%')
          .padding({ top: 24, left: 20, right: 20, bottom: 24 })
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r("app.color.backgroundColor"))
  }
}

// å¡ç‰‡æ ·å¼ç»„ä»¶
@Component
struct Card {
  @BuilderParam content: () => void

  build() {
    Column() {
      this.content()
    }
    .width('100%')
    .backgroundColor($r("app.color.HealthbackgroundColor"))
    .borderRadius(12)
    .shadow({
      radius: 4,
      color: '#00000008',
      offsetX: 0,
      offsetY: 2
    })
  }
}

